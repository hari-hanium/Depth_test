<!DOCTYPE html>
<html>
    <head>
        <style>
            table {
                display: inline-block;
            }

            #score {
                border: 1px solid;

                padding: 10px;

                font-size: 12px;
            }

            #score td {
                text-align: center;
            }

            .title {
                font-size: 16px;
            }

            .small {
                font-size: 8px;
            }

            #yut {
                border: 1px solid;

                padding: 10px;
                
                background: palegoldenrod;
            }

            #yut td {
                text-align: center;
            }

            .cell {
                width: 10px;
                height: 10px;

                border: 1px solid;
                border-radius: 100px;
                
                display: inline-block;

                margin-left: 5px;
                margin-right: 5px;
                
                background: paleturquoise;
            }

            .block {
                display: block;

                margin: auto;

                margin-top: 17.5px;
                margin-bottom: 17.5px;
            }

            .big {
                width: 20px;
                height: 20px;
                
                vertical-align: middle;
                line-height: 10px;

                margin: 0;
                
                background: palevioletred;
            }

            .center {
                background: palegreen;
            }

            .none {
                border: transparent;
                background: transparent;
            }

            .user {
                width: 20px;
                height: 20px;

                line-height: 17.5px;
                
                border: 1px solid;
                
                margin-left: -6px;
                margin-top: -6px;
            }

            .big .user {
                margin-left: -1px;
                margin-top: -1px;
            }

            .user_1, .user_1_unit {
                background: darkseagreen;
            }

            .user_2, .user_2_unit {
                background: darkorange;
            }

            .user_3, .user_3_unit {
                background: goldenrod;
            }

            .user_4, .user_4_unit {
                background: plum;
            }

            .line_3 {
                text-align: center;
            }

            .line_4 {
                text-align: center;
            }

            #shot {
                width: 250px;
                height: 250px;

                border: 1px solid;
            }
        </style>
    </head>
    <body>
        <table id="shot">
            <tr>
                <td></td>
            </tr>
        </table>
        <table id="yut">
            <tr>
                <td rowspan="7">
                    <div id="cell_10" class="cell big block"></div>
                    <div id="cell_11" class="cell block"></div>
                    <div id="cell_12" class="cell block"></div>
                    <div id="cell_13" class="cell block"></div>
                    <div id="cell_14" class="cell block"></div>
                    <div id="cell_15" class="cell big block"></div>
                </td>
                <td class="line_1">
                    <div id="cell_9" class="cell"></div>
                    <div id="cell_8" class="cell"></div>
                    <div id="cell_7" class="cell"></div>
                    <div id="cell_6" class="cell"></div>
                </td>
                <td rowspan="7">
                    <div id="cell_5" class="cell big block"></div>
                    <div id="cell_4" class="cell block"></div>
                    <div id="cell_3" class="cell block"></div>
                    <div id="cell_2" class="cell block"></div>
                    <div id="cell_1" class="cell block"></div>
                    <div id="cell_0" class="cell big block"></div>
                </td>
            </tr>
            <tr>
                <td class="line_2">
                    <div id="cell_201" class="cell"></div>
                    <div class="cell none"></div>
                    <div class="cell none"></div>
                    <div id="cell_101" class="cell"></div>
                </td>
            </tr>
            <tr>
                <td class="line_3">
                    <div id="cell_202" class="cell"></div>
                    <div id="cell_102" class="cell"></div>
                </td>
            </tr>
            <tr>
                <td class="line_4">
                    <div id="cell_103" class="cell big center"></div>
                </td>
            </tr>
            <tr>
                <td class="line_3">
                    <div id="cell_104" class="cell"></div>
                    <div id="cell_204" class="cell"></div>
                </td>
            </tr>
            <tr>
                <td class="line_2">
                    <div id="cell_105" class="cell"></div>
                    <div class="cell none"></div>
                    <div class="cell none"></div>
                    <div id="cell_205" class="cell"></div>
                </td>
            </tr>
                <td class="line_1">
                    <div id="cell_16" class="cell"></div>
                    <div id="cell_17" class="cell"></div>
                    <div id="cell_18" class="cell"></div>
                    <div id="cell_19" class="cell"></div>
                </td>
            </tr>
        </table>
        <table id="score">
            <tr>
                <td colspan="2">
                    <div class="title">점수판</div>
                </td>
            </tr>
            <tr>
                <td class="user_1">사용자 1</td>
                <td id="user_1_count">0점</td>
            </tr>
            <tr>
                <td class="small">남은 말</td>
                <td class="small" id="user_1_unit_count">4개</td>
            </tr>
            <tr>
                <td class="user_2">사용자 2</td>
                <td id="user_2_count">0점</td>
            </tr>
            <tr>
                <td class="small">남은 말</td>
                <td class="small" id="user_2_unit_count">4개</td>
            </tr>
            <tr>
                <td class="user_3">사용자 3</td>
                <td id="user_3_count">0점</td>
            </tr>
            <tr>
                <td class="small">남은 말</td>
                <td class="small" id="user_3_unit_count">4개</td>
            </tr>
            <tr>
                <td class="user_4">사용자 4</td>
                <td id="user_4_count">0점</td>
            </tr>
            <tr>
                <td class="small">남은 말</td>
                <td class="small" id="user_4_unit_count">4개</td>
            </tr>
        </table>
        <script>
            "use strict";

            function update_score() {
                for(let for_a = 0; for_a < 4; for_a++) {
                    let score;
                    let unit;
                    if(for_a < player) {
                        score = String(player_point[for_a]) + "점";
                        unit = String(player_unit[for_a]) + "개";
                    } else {
                        score = "";
                        unit = "";
                    }

                    document.getElementById("user_" + String(for_a + 1) + "_count").innerHTML = score;
                    document.getElementById("user_" + String(for_a + 1) + "_unit_count").innerHTML = unit;
                }
            }

            function calc_to(from, to) {
                if(from === 5) {
                    from = 100;
                } else if(from === 10) {
                    from = 200;
                } else if(from === 103) {
                    from = 203;
                } else if(from === 0 && to === -1) {
                    from = 20;
                }

                let calc = from + to;
                if(calc === 100) {
                    calc = 5;
                } else if(calc === 200) {
                    calc = 10;
                } else if(calc === 203) {
                    calc = 103;
                }

                console.log('calc', calc, from, to);
                if(100 <= calc && calc < 200) {
                    if(106 <= calc) {
                        calc = calc - 106 + 15;
                    }
                } else if(200 <= calc) {
                    if(calc === 206) {
                        calc = 0;
                    } else if(206 < calc) {
                        calc = '';
                    }
                } else {
                    if(calc === 20) {
                        calc = 0;
                    } else if(20 < calc) {
                        calc = '';
                    } else if(from === 0) {
                        calc = '';
                    }
                }

                console.log('calc_end', calc);
                return calc;
            }

            function batch_unit(from, to) {
                console.log('batch', from, to);

                let count = 1;
                if(from !== '') {
                    count = cell_unit[from][1];
                    cell_unit[from] = undefined;
                } else {
                    player_unit[player_turn] -= 1;
                }

                if(to === "") {
                    player_point[player_turn] += count;
                } else {
                    if(cell_unit[to] !== undefined) {
                        if(cell_unit[to][0] !== player_turn) {
                            player_unit[cell_unit[to][0]] += cell_unit[to][1];
                            cell_unit[to] = [player_turn, count];
                        } else {
                            cell_unit[to][1] += 1;
                        }
                    } else {
                        cell_unit[to] = [player_turn, count];
                    }
                }

                console.log(cell_unit);
                
                remove_unit_select();
            }

            function remove_unit_select() {
                for(let for_a = 0; for_a < document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit').length; for_a++) {
                    console.log([for_a, document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit')[for_a]]);
                    document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit')[for_a].addEventListener('click', function() {});
                }

                render_batch();
            }

            function add_unit_select(to) {
                for(let for_a = 0; for_a < document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit').length; for_a++) {
                    console.log([for_a, document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit')[for_a]]);
                    document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit')[for_a].addEventListener('click', function() {
                        let from = document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit')[for_a].id;
                        
                        console.log(['add_unit_select', Number(from), to]);
                        batch_unit(Number(from), calc_to(Number(from), to));
                    });
                }
            }

            function render_batch() {
                for(let key in cell_unit) {
                    if(cell_unit[key] !== undefined) {
                        let turn = String(cell_unit[key][0] + 1);
                        let count = String(cell_unit[key][1]);
                        if(count === '1') {
                            count = '';
                        }
                        
                        console.log(turn, count);
                        document.getElementById('cell_' + String(key)).innerHTML = '<div class="user user_' + turn + '_unit" id="' + String(key) + '">' + count + '</div>';
                    } else {
                        document.getElementById('cell_' + String(key)).innerHTML = '';
                    }
                }

                console.log('점수표 초기화');
                update_score();
                
                setTimeout(function() {
                    do_game();
                }, 3000);
            }

            let player = prompt("인원을 입력해주세요. (최대 4명)");
            if(player === 'break') {
                throw 'dev';
            }

            player = Number(player);
            console.log('인원 ' + String(player) + '명');

            let player_point = [];
            let player_unit = [];
            let cell_unit = {};
            let repeat = 0;
            let player_turn = -1;

            for(let for_a = 0; for_a < player; for_a++) {
                player_point.push(0);
                player_unit.push(4);
            }
            console.log('초기 선언 ' + String(player_point));

            console.log('점수표 초기화');
            update_score();

            console.log('게임 시작');
            do_game();

            function do_game() {
                if(player_point.includes(4)) {
                    for(let for_a = 0; for_a < player_point.length; for_a++) {
                        if(player_point[for_a] === 4) {
                            console.log("사용자 " + String(for_a + 1) + " 승리 (다시하려면 F5를 눌러주세요)");
                        }
                    }

                    return;
                }

                if(repeat === 1) {
                    player_turn -= 1;
                    repeat = 0;
                }

                player_turn += 1;
                if(player_turn >= player) {
                    player_turn = 0;
                }
                
                let check = confirm("사용자 " + String(player_turn + 1) + " 윷을 던지겠습니까?");
                if(check === true) {
                    setTimeout(function() {
                        let A = Math.random() >= 0.5 ? 1 : 0;
                        let B = Math.random() >= 0.5 ? 1 : 0;
                        let C = Math.random() >= 0.5 ? 1 : 0;
                        let D = Math.random() >= 0.5 ? 1 : 0;

                        // 0 앞 1 뒤
                        console.log(A, B, C, D);
                        let yut;
                        if(A === 0 && B === 1 && C === 1 && D === 1) {
                            alert("백도");
                            yut = 0;
                        } else if(A + B + C + D === 3) {
                            alert("도");
                            yut = 1;
                        } else if(A + B + C + D === 2) {
                            alert("개");
                            yut = 2;
                        } else if(A + B + C + D === 1) {
                            alert("걸");
                            yut = 3;
                        } else if(A + B + C + D === 0) {
                            alert("윷");
                            yut = 4;
                        } else if(A + B + C + D === 4) {
                            alert("모");
                            yut = 5;
                        }

                        if(yut === 4 || yut === 5) {
                            repeat = 1;
                        }

                        let new_unit = false;
                        if(player_unit[player_turn] !== 0) {
                            if(document.getElementsByClassName('user_' + String(player_turn + 1) + '_unit').length !== 0) {
                                if(yut === 0) {
                                    new_unit = false;
                                } else {
                                    new_unit = confirm('새 말을 배치하겠습니까?');
                                }
                            } else {
                                new_unit = true;
                            }
                            
                            if(new_unit === true) {
                                console.log('사용자 ' + String(player_turn + 1) + ' 새 말 배치');

                                batch_unit('', yut);
                            }
                        }

                        if(new_unit === false) {
                            console.log('사용자 ' + String(player_turn + 1) + ' 새 말 배치 안함');
                            if(yut === 0) {
                                yut = -1;
                            }

                            add_unit_select(yut);
                        }
                    }, 3000);
                } else {
                    console.log('윷 안 던짐');
                    setTimeout(function() {
                        player_turn -= 1;
                        
                        do_game();
                    }, 3000);
                }
            }
            console.log(player_point);
        </script>
    </body>
</html>